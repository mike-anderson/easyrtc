/*! easyrtc 1.0.12 Copyright (c) 2014, Priologic Software Inc. All rights reserved. */
!function(a){if("function"==typeof define&&define.amd)define(["socket.io"],a);else if("object"==typeof exports&&exports){var b=require("socket.io");module.exports=a(b)}else{if("object"!=typeof window.io||!window.io)throw new Error("EasyRTC requires socket.io \nhttp://easyrtc.com/docs/guides/easyrtc_client_tutorial.php");window.easyrtc=a(window.io)}}(function(a,b){var c=null,d=null,e=null,f=null,g=null;if(navigator.mozGetUserMedia){f="firefox";var h=navigator.userAgent.match(/\srv:([0-9]+)\./);null!==h&&h.length>1&&(g=parseInt(h[1])),window.RTCPeerConnection=mozRTCPeerConnection,window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,window.getUserMedia=navigator.mozGetUserMedia.bind(navigator),window.createIceServer=function(a,b,c){var d,e=null,f=a.split(":");return 0===f[0].indexOf("stun")?e={url:a}:0!==f[0].indexOf("turn")||-1===a.indexOf("transport=udp")&&-1!==a.indexOf("?transport")||(d=a.split("?"),e={url:d[0],credential:c,username:b}),e},d=function(a,b){a.mozSrcObject=b,a.play()},e=function(a,b){a.mozSrcObject=b.mozSrcObject,a.play()},23>g&&(MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]})}else navigator.webkitGetUserMedia?(f="chrome",g=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),window.createIceServer=function(a,b,c){var d,e=null,f=a.split(":");return 0===f[0].indexOf("stun")?e={url:a}:0===f[0].indexOf("turn")&&(28>g?(d=a.split("turn:"),e={url:"turn:"+b+"@"+d[1],credential:c}):e={url:a,credential:c,username:b}),e},window.RTCPeerConnection=webkitRTCPeerConnection,window.getUserMedia=navigator.webkitGetUserMedia.bind(navigator),d=function(a,b){"undefined"!=typeof a.srcObject?a.srcObject=b:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):console.log("Error attaching stream to element.")},e=function(a,b){a.src=b.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable");window.createIceServer||(window.createIceServer=function(a,b,c){return{url:a,credential:c,username:b}});var i=function(){function e(a){if("string"!=typeof a)throw P.showError(P.errCodes.DEVELOPER_ERR,src+" called without a string as the first argument"),"developer error";if(!V[a])throw P.showError(P.errCodes.DEVELOPER_ERR,src+" called with a bad event name = "+a),"developer error"}function h(a){pb&&clearTimeout(pb),pb=setTimeout(function(){i(a,P._roomApiFields[a]),pb=null},10)}function i(a,b){var c=JSON.stringify(b);JSON.parse(c);var d={msgType:"setRoomApiField",msgData:{setRoomApiField:{roomName:a,field:b}}};P.webSocket.json.emit("easyrtcCmd",d,function(a){"error"===a.msgType&&P.showError(a.msgData.errorCode,a.msgData.errorText)})}function k(a,b){var c;if(b)for(c=0;c<b.length;c++){var d=b[c];d.enabled=a}}function l(a){return a||(a="default"),X.hasOwnProperty(a)?X[a]:null}function m(){var a,b={};for(a in X)b[a]=X[a].id||"anonymous";return b}function n(a,b){var c;if(b||(b="default"),X[b]=a,"default"!==b){var d=m();for(c in P.roomData)P.setRoomApiField(c,"mediaIds",d)}}function o(a,c){var d,e,f;if(c||(c="anonymous"),nb[a]&&(f=nb[a].remoteStreamIdToName[c]))return f;for(d in P.roomData)if(e=P.getRoomApiField(d,a,"mediaIds"))for(f in e)if(e.hasOwnProperty(f)&&e[f]===c)return f;return b}function p(a){a||(a="default");var b=P.getLocalStream(a);if(b){var c=b.id||"anonymous";if(X[a]){for(id in nb)if(nb.hasOwnProperty(id)){try{nb[id].pc.removeStream(b)}catch(d){}P.sendPeerMessage(id,"__closingMediaStream",{streamId:c,streamName:a})}try{X[a].stop()}catch(d){}if(delete X[a],"default"!==a){var e=m();for(roomName in P.roomData)P.setRoomApiField(roomName,"mediaIds",e)}}}}function q(a,b,c){var d,e;if(a){if(e=nb[a],!e)return console.error("Developer error: haveTracks called about a peer you don't have a connection to"),!1;d=e.getRemoteStreamByName(c)}else d=l(c);if(!d)return!1;var f;try{f=b?d.getAudioTracks():d.getVideoTracks()}catch(g){return!0}return f?f.length>0:!1}function r(a){if(null===a||a===b)return!0;var c;for(c in a)if(a.hasOwnProperty(c))return!1;return!0}function s(){var a;if(P.loggingOut=!0,cb={},ob={},P.disconnecting=!0,tb=P.webSocket,P.webSocketConnected&&(Eb||P.webSocket.close(),P.webSocketConnected=!1),P.hangupAll(),gb)for(a in jb)jb.hasOwnProperty(a)&&gb(a,{},!1);P.emitEvent("roomOccupant",{}),P.loggingOut=!1,P.disconnecting=!1,bb={}}function t(a,b,c,d,e){if(!P.webSocket)throw"Attempt to send message without a valid connection to the server.";var f={msgType:b};a&&(f.targetEasyrtcid=a),c&&(f.msgData=c),P.debugPrinter&&P.debugPrinter("sending socket message "+JSON.stringify(f)),P.webSocket.json.emit("easyrtcCmd",f,function(a){"error"!==a.msgType?(a.hasOwnProperty("msgData")||(a.msgData=null),d&&d(a.msgType,a.msgData)):e?e(a.msgData.errorCode,a.msgData.errorText):P.showError(a.msgData.errorCode,a.msgData.errorText)})}function u(){var a=[];return a.push({DtlsSrtpKeyAgreement:"true"}),{optional:a}}function v(a,b,c,d,e){ob[a]=!0;var f=vb(a,!0,c,e);if(!f)throw message="buildPeerConnection failed, call not completed",P.debugPrinter&&P.debugPrinter(message),message;nb[a].callSuccessCB=b,nb[a].callFailureCB=c,nb[a].wasAcceptedCB=d;var g=nb[a],h=function(b){if(!g.cancelled){var d=function(){t(a,"offer",b,null,c)};S&&(b.sdp=S(b.sdp)),f.setLocalDescription(b,d,function(a){c(P.errCodes.CALL_ERR,a)})}};setTimeout(function(){f.createOffer(h,function(a){c(P.errCodes.CALL_ERR,JSON.stringify(a))},Z)},100)}function w(a){var b;if(P.debugPrinter&&P.debugPrinter("Hanging up on "+a),Ab(a),nb[a]){if(nb[a].pc){var c=nb[a].pc.getRemoteStreams();for(b=0;b<c.length;b++){y(a,c[b]);try{c[b].close()}catch(d){}}try{nb[a].pc.close()}catch(d){}}nb[a].cancelled=!0,delete nb[a],P.webSocket&&t(a,"hangup",null,function(){},function(a,b){P.debugPrinter&&P.debugPrinter("hangup failed:"+b)}),ob[a]&&delete ob[a]}}function x(a,b){nb[a]&&(y(a,b),mb())}function y(a,b){if(nb[a]){var c,d;d=b.hasOwnProperty("id")?b.id:"anonymous",c=nb[a].remoteStreamIdToName[d]||"default",P.onStreamClosed&&P.onStreamClosed(a,b,c),delete nb[a].remoteStreamIdToName[d]}}function z(a){var b;for(b in jb)if(jb.hasOwnProperty(b)&&jb[b][a])return!0;return!1}function A(a){var b;for(b in nb)nb.hasOwnProperty(b)&&"undefined"==typeof a[b]&&(z(b)||((nb[b].pc||nb[b].isInitiator)&&yb(b),delete cb[b],delete ob[b],Ab(b)));for(b in cb)cb.hasOwnProperty(b)&&!z(b)&&(yb(b),Ab(b),delete cb[b],delete ob[b]);for(b in ob)ob.hasOwnProperty(b)&&!z(b)&&(yb(b),Ab(b),delete ob[b])}function B(a,b){var c=null;P.reducedList={};var d;for(d in b)b.hasOwnProperty(d)&&(d===P.myEasyrtcid?c=b[d]:P.reducedList[d]=b[d]);A(P.reducedList),gb&&gb(a,P.reducedList,c)}function C(a,b,c){var d;for(d=0;d<nb[a].candidatesToSend.length;d++)t(a,"candidate",nb[a].candidatesToSend[d],b,c)}function D(b,c){function d(a,b){P.webSocket.on(a,b),P.websocketListeners.push({event:a,handler:b})}var e;if(Eb)P.webSocket=Eb;else if(P.webSocket)for(e in P.websocketListeners)P.websocketListeners.hasOwnProperty(e)&&P.webSocket.removeEventListener(P.websocketListeners[e].event,P.websocketListeners[e].handler);else if(P.webSocket=a.connect(fb,{"connect timeout":1e4,"force new connection":!0}),!P.webSocket)throw"io.connect failed";P.websocketListeners=[],d("close",function(){console.log("the web socket closed")}),d("error",function(){function a(){P.myEasyrtcid?P.webSocket.connected||P.webSocket.socket&&P.webSocket.socket.connected?P.showError(P.errCodes.SIGNAL_ERROR,P.getConstantString("miscSignalError")):console.warn("The connection to the EasyRTC socket server went down. It may come back by itself."):c(P.errCodes.CONNECT_ERR,P.getConstantString("noServer"))}a()}),d("connect",function(){P.webSocketConnected=!0,P.webSocket||P.showError(P.errCodes.CONNECT_ERR,P.getConstantString("badsocket")),P.debugPrinter&&P.debugPrinter("saw socketserver onconnect event"),P.webSocketConnected?M(b,c):c(P.errCodes.SIGNAL_ERROR,P.getConstantString("icf"))}),d("easyrtcMsg",Bb),d("easyrtcCmd",Cb),d("disconnect",function(){P.webSocketConnected=!1,mb=function(){},bb={},s(),P.disconnectListener&&P.disconnectListener()})}function E(a,b){function c(a){var b;for(b in a)if(a.hasOwnProperty(b))return!0;return!1}var d={};return c(a)&&(d.added=a),c(b)&&(d.deleted=b),c(d)?d:null}function F(a,b){var c,d,e={},f={};for(c in b)b.hasOwnProperty(c)&&(null===a||"undefined"==typeof a[c]?e[c]=b[c]:"object"==typeof b[c]?(d=F(a[c],b[c]),null!==d&&(e[c]=b[c])):b[c]!==a[c]&&(e[c]=b[c]));for(c in a)b.hasOwnProperty(c)&&"undefined"==typeof b[c]&&(f=a[c]);return E(e,f)}function G(){var a,b={};for(a in nb)nb.hasOwnProperty(a)&&(b[a]={connectTime:nb[a].connectTime,isInitiator:!!nb[a].isInitiator});var c={userSettings:{sharingAudio:!!U.audio,sharingVideo:!!U.video,sharingData:!!eb,nativeVideoWidth:P.nativeVideoWidth,nativeVideoHeight:P.nativeVideoHeight,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenWidth:window.screen.width,screenHeight:window.screen.height,cookieEnabled:navigator.cookieEnabled,os:navigator.oscpu,language:navigator.language}};return r(b)||(c.p2pList=b),c}function H(){var a=G(!1),b=function(){var b=F(bb,a);b&&(P.debugPrinter&&P.debugPrinter("cfg="+JSON.stringify(b.added)),P.webSocket&&t(null,"setUserCfg",{setUserCfg:b.added},null,null)),bb=a};bb==={}?b():setTimeout(b,100)}function I(a){a&&(a.easyrtcsid&&(P.easyrtcsid=a.easyrtcsid),a.field&&(Y=a.field))}function J(a){P.roomData=a;var b,c,d,e,f;for(b in P.roomData)if(P.roomData.hasOwnProperty(b)){if("join"===a[b].roomStatus)P.roomJoin[b]||(P.roomJoin[b]=a[b]);else if("leave"===a[b].roomStatus){P.roomEntryListener&&P.roomEntryListener(!1,b),delete P.roomJoin[b];continue}if(a[b].clientList)jb[b]=a[b].clientList;else if(a[b].clientListDelta){if(d=a[b].clientListDelta.updateClient)for(e in d)d.hasOwnProperty(e)&&(jb[b]||(jb[b]=[]),jb[b][e]=d[e]);if(c=a[b].clientListDelta.removeClient,c&&jb[b])for(f in c)c.hasOwnProperty(f)&&delete jb[b][f]}P.roomJoin[b]&&a[b].field&&(ub.rooms[b]=a[b].field),"join"===a[b].roomStatus&&P.roomEntryListener&&P.roomEntryListener(!0,b),B(b,jb[b])}P.emitEvent("roomOccupant",jb)}function K(a){qb={iceServers:[]},P._turnServers={};var b,c,d,e;if(window.createIceServer)for(b=0;b<a.iceServers.length;b++)c=a.iceServers[b],0===c.url.indexOf("turn:")?(c.username?d=createIceServer(c.url,c.username,c.credential):P.showError("Developer error","Iceserver entry doesn't have a username: "+JSON.stringify(c)),e=c.url.split(/[@:&]/g)[1],P._turnServers[e]=!0):d=c,d&&qb.iceServers.push(d)}function L(a){P.debugPrinter&&P.debugPrinter("entered process token");var b=a.msgData;b.easyrtcid&&(P.myEasyrtcid=b.easyrtcid),b.field&&(ub.connection=b.field),b.iceConfig&&K(b.iceConfig),b.sessionData&&I(b.sessionData),b.roomData&&J(b.roomData),b.application.field&&(ub.application=b.application.field)}function M(a,b){var c,d,e,f=null;if(P.cookieId&&document.cookie)for(c=document.cookie.split(/[; ]/g),d=P.cookieId+"=",e=0;e<c.length;e++)0===c[e].indexOf(d)&&(f=c[e].substring(d.length));P.roomJoin||(P.roomJoin={});var g={apiVersion:P.apiVersion,applicationName:P.applicationName,setUserCfg:G(!0)};P.presenceShow&&(g.setPresence={show:P.presenceShow,status:P.presenceStatus}),P.username&&(g.username=P.username),P.roomJoin&&!r(P.roomJoin)&&(g.roomJoin=P.roomJoin),f&&(g.easyrtcsid=f),db&&(g.credential=db),P.webSocket.json.emit("easyrtcAuth",{msgType:"authenticate",msgData:g},function(c){var d;if("error"===c.msgType)b(c.msgData.errorCode,c.msgData.errorText),P.roomJoin={};else{if(L(c),P._roomApiFields)for(d in P._roomApiFields)P._roomApiFields.hasOwnProperty(d)&&h(d,P._roomApiFields[d]);a&&a(P.myEasyrtcid)}})}function N(a,b){var c;if(a&&!document.getElementById(a))return P.showError(P.errCodes.DEVELOPER_ERR,"The monitor video id passed to easyApp was bad, saw "+a),!1;for(c in b)if(b.hasOwnProperty(c)){var d=b[c];if(!document.getElementById(d))return P.showError(P.errCodes.DEVELOPER_ERR,"The caller video id '"+d+"' passed to easyApp was bad."),!1}return!0}function O(a,c){function d(a){return""===a.dataset.caller||null===a.dataset.caller||a.dataset.caller===b}function e(a){return h[a]?document.getElementById(h[a]):null}function f(a){P.setVideoObjectSrc(a,""),a.style.visibility="hidden"}var g=c.length,h=c,i=0,j=null,k=null;if(h||(h=[]),!N(a,h))throw"bad video element id";a&&(document.getElementById(a).muted="muted"),P.setOnCall=function(a){j=a},P.setOnHangup=function(a){k=a},P.getIthCaller=function(a){if(0>a||a>h.length)return null;var b=e(a);return b.dataset.caller},P.getSlotOfCaller=function(a){var b;for(b=0;g>b;b++)if(P.getIthCaller(b)===a)return b;return-1},P.setOnStreamClosed(function(a){var b;for(b=0;g>b;b++){var c=e(b);c.dataset.caller===a&&(f(c),c.dataset.caller="",k&&k(a,b))}}),P.setAcceptChecker(function(a,b){var c;for(c=0;g>c;c++){var f=e(c);if(d(f))return void b(!0)}b(!1)}),P.setStreamAcceptor(function(a,b){function c(a,b){P.setVideoObjectSrc(a,b),a.style.visibility&&(a.style.visibility="visible")}var f;P.debugPrinter&&P.debugPrinter("stream acceptor called");var h;if(i&&d(i))return c(i,b),j&&j(a,i),void(i=null);for(f=0;g>f;f++)if(h=e(f),h.dataset.caller===a)return c(h,b),void(j&&j(a,f));for(f=0;g>f;f++)if(h=e(f),!h.dataset.caller||d(h))return h.dataset.caller=a,j&&j(a,f),void c(h,b);h=e(0),h&&(P.hangup(h.dataset.caller),c(h,b),j&&j(a,0)),h.dataset.caller=a}),function(){var a,b,c,d;if(Db)for(a=function(a){b=a.parentNode,a.dataset.caller="",c=document.createElement("div"),c.className="easyrtc_closeButton",c.onclick=function(){a.dataset.caller&&(P.hangup(a.dataset.caller),f(a),a.dataset.caller="")},b.appendChild(c)},d=0;g>d;d++)a(e(d))}();var l=null;if(_&&null!==a){if(l=document.getElementById(a),!l)return void console.error("Programmer error: no object called "+a);l.muted="muted",l.defaultMuted=!0}}var P=this,Q="firefox"===f,R=!0,S=null,T=null;this.setSdpFilters=function(a,b){S=a,T=b},this.setAutoInitUserMedia=function(a){R=!!a},this.format=function(){for(var a=arguments[0],b=1;b<arguments.length;b++){var c=new RegExp("\\{"+(b-1)+"\\}","gi");a=a.replace(c,arguments[b])}return a};var U={audio:!1,video:!1};this.getConstantString=function(a){return j[a]?j[a]:(console.warn("Could not find key='"+a+"' in easyrtc_constantStrings"),a)};var V={roomOccupant:!0},W={};this.addEventListener=function(a,b){if(e(a,"addEventListener"),"function"!=typeof b)throw P.showError(P.errCodes.DEVELOPER_ERR,"addEventListener called with a non-function for second argument"),"developer error";P.removeEventListener(a,b),W[a]||(W[a]=[]),W[a][W[a].length]=b},this.removeEventListener=function(a,b){e(a,"removeEventListener");var c=W[a],d=0;if(c)for(d=0;d<c.length;d++)c[d]===b&&(d<c.length-1&&(c[d]=c[c.length-1]),c.length=c.length-1)},this.emitEvent=function(a,b){e(a,"emitEvent");var c=W[a],d=0;if(c)for(d=0;d<c.length;d++)c[d](a,b)},this.errCodes={BAD_NAME:"BAD_NAME",CALL_ERR:"CALL_ERR",DEVELOPER_ERR:"DEVELOPER_ERR",SYSTEM_ERR:"SYSTEM_ERR",CONNECT_ERR:"CONNECT_ERR",MEDIA_ERR:"MEDIA_ERR",MEDIA_WARNING:"MEDIA_WARNING",INTERNAL_ERR:"INTERNAL_ERR",PEER_GONE:"PEER_GONE",ALREADY_CONNECTED:"ALREADY_CONNECTED",BAD_CREDENTIAL:"BAD_CREDENTIAL"},this.apiVersion="1.0.12",this.ackMessage={msgType:"ack"},this.usernameRegExp=/^(.){1,64}$/;var X={},Y=[],Z={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};this.enableAudioReceive=function(a){Z.mandatory.OfferToReceiveAudio=a},this.enableVideoReceive=function(a){Z.mandatory.OfferToReceiveVideo=a},this.getVideoSourceList=function(a){MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(b){for(var c=[],d=0;d<b.length;d++){var e=b[d];"video"===e.kind&&c.push(e)}a(c)}):a([])};var $=!0,_=!0,ab="dc";this.debugPrinter=null,this.myEasyrtcid="";var bb={},cb={};this.nativeVideoHeight=0,this.nativeVideoWidth=0;var db=null;this.roomJoin={},this.isNameValid=function(a){return P.usernameRegExp.test(a)},this.setCookieId=function(a){P.cookieId=a},this.joinRoom=function(a,b,c,d){if(P.roomJoin[a])return void console.error("Developer error: attempt to join room "+a+" which you are already in.");var e=m(),f={roomName:a};if(b){try{JSON.stringify(b)}catch(g){throw P.showError(P.errCodes.DEVELOPER_ERR,"non-jsonable parameter to easyrtc.joinRoom"),"Developer error, see application error messages"}var h={};for(var i in b)b.hasOwnProperty(i)&&(h[i]=b[i]);f.roomParameter=h}var j,k,l,n={roomJoin:{}};P.webSocket?(n.roomJoin[a]=f,k=function(b,d){j=d.roomData,P.roomJoin[a]=f,c&&c(a),J(j)},l=function(b,c){d?d(b,c,a):P.showError(b,P.format(P.getConstantString("unableToEnterRoom"),a,c))},t(null,"roomJoin",n,k,l)):P.roomJoin[a]=f,e!=={}&&P.setRoomApiField(a,"mediaIds",e)},this.leaveRoom=function(a,b,c){var d;P.roomJoin[a]&&(P.webSocket?(d={},d[a]={roomName:a},t(null,"roomLeave",{roomLeave:d},function(c,d){var e=d.roomData;J(e),b&&b(a)},function(b,d){c&&c(b,d,a)})):delete P.roomJoin[a])},this._desiredVideoProperties={},this.setVideoSource=function(a){P._desiredVideoProperties.videoSrcId=a,delete P._desiredVideoProperties.screenCapture},this.setVideoSrc=this.setVideoSource,delete this._desiredVideoProperties.screenCapture,this.setVideoDims=function(a,c,d){a||(a=1280,c=720),P._desiredVideoProperties.width=a,P._desiredVideoProperties.height=c,d!==b&&(P._desiredVideoProperties.frameRate=d)},this.setScreenCapture=function(a){P._desiredVideoProperties.screenCapture=a!==!1},P.getUserMediaConstraints=function(){var a={};if(_){if(P._desiredVideoProperties.screenCapture)return{video:{mandatory:{chromeMediaSource:"screen",maxWidth:screen.width,maxHeight:screen.height,minWidth:screen.width,minHeight:screen.height,minFrameRate:1,maxFrameRate:5},optional:[]}};a.video={mandatory:{},optional:[]},P._desiredVideoProperties.width&&(a.video.mandatory.maxWidth=P._desiredVideoProperties.width,a.video.mandatory.minWidth=P._desiredVideoProperties.width),P._desiredVideoProperties.width&&(a.video.mandatory.maxHeight=P._desiredVideoProperties.height,a.video.mandatory.minHeight=P._desiredVideoProperties.height),P._desiredVideoProperties.frameRate&&(a.video.mandatory.maxFrameRate=P._desiredVideoProperties.frameRate),P._desiredVideoProperties.videoSrcId&&a.video.optional.push({sourceId:P._desiredVideoProperties.videoSrcId}),0===a.video.mandatory.length&&0===a.video.optional.length&&(a.video=!0)}else a.video=!1;return a.audio=$,a},this.setApplicationName=function(a){P.applicationName=a},this.enableDebug=function(a){P.debugPrinter=a?function(a){var b=(new Error).stack,c="location unknown";if(b){var d=b.split("\n");c="",d.length>=3&&(c=d[2])}console.log("debug "+(new Date).toISOString()+" : "+a+" ["+c+"]")}:null},this.updatePresence=function(a,b){P.presenceShow=a,P.presenceStatus=b},this.supportsGetUserMedia=function(){return!!c},this.supportsPeerConnections=function(){if(!P.supportsGetUserMedia())return!1;if(!window.RTCPeerConnection)return!1;try{P.createRTCPeerConnection({iceServers:[]},null)}catch(a){return!1}return!0},this.createRTCPeerConnection=function(a,b){if(RTCPeerConnection)return new RTCPeerConnection(a,b);throw"Your browser doesn't support webRTC (RTCPeerConnection)"},this.getDatachannelConstraints=function(){return"chrome"===f&&31>g?{reliable:!1}:{reliable:!0}},U={audio:!1,video:!1};var eb=!1,fb=null,gb=null,hb=null,ib=null,jb={},kb={msgTypes:{}},lb=null,mb=function(){},nb={},ob={};this.disconnect=function(){},this.acceptCheck=function(a,b){b(!0)},this.streamAcceptor=function(){},this.onStreamClosed=function(){},this.callCancelled=function(){},this.getPeerStatistics=function(a,b,c){Q?P.getFirefoxPeerStatistics(a,b,c):P.getChromePeerStatistics(a,b,c)},this.getFirefoxPeerStatistics=function(a,b,c){nb[a]?nb[a].pc.getStats?nb[a].pc.getStats(null,function(d){var e,f={};if(d.forEach(function(a){var b,c;if(a.type.match(/boundrtp/)){if(a.id.match(/audio/))b=a.type+"_audio";else{if(!a.id.match(/video/))return;b=a.type+"_video"}for(c in a)a.hasOwnProperty(c)&&(f[b+"."+c]=a[c])}}),c){var g={};for(e in c)c.hasOwnProperty(e)&&f.hasOwnProperty(e)&&(g[c[e]]=f[e]);b(a,g)}else b(a,f)},function(){console.log("unable to get statistics")}):b({statistics:P.getConstantString("statsNotSupported")}):b({notConnected:a})},this.getChromePeerStatistics=function(a,b,c){nb[a]?nb[a].pc.getStats?nb[a].pc.getStats(function(d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r={},s=d.result(),t=[],u=0,v=null;if(c){for(f=0;f<s.length;f++){for(t[f]={},j=s[f].names(),g=0;g<j.length;g++)t[f][j[g]]=!0;t[f].googRemoteAddress&&t[f].googActiveConnection&&(n=s[f].local.stat("googActiveConnection"),(n===!0||"true"===n)&&(o=parseInt(s[f].local.stat("bytesReceived"))+parseInt(s[f].local.stat("bytesSent")),o>u&&(m=f,u=o)))}for(f=0;f<s.length;f++)t[f].googActiveConnection&&(f!==m?t[f]={}:(p=s[f].local.stat("googLocalAddress").split(":")[0],q=s[f].local.stat("googRemoteAddress").split(":")[0],P.isTurnServer(p)?v=p:P.isTurnServer(q)&&(v=q)));for(f=0;f<c.length;f++){for(h=c[f],l=[],e=null,g=0;g<s.length;g++){var w=!0;for(i in h)if(h.hasOwnProperty(i)&&!t[g][i]){w=!1;break}w&&s[g]&&l.push(s[g])}if(1===l.length){for(g=0;g<l.length;g++)if(e=l[g],e.local)for(i in h)h.hasOwnProperty(i)&&(k=h[i],r[k]=e.local.stat(i))}else if(l.length>1){for(i in h)h.hasOwnProperty(i)&&(r[h[i]]=[]);for(g=0;g<l.length;g++)if(e=l[g],e.local)for(i in h)h.hasOwnProperty(i)&&(k=h[i],r[k].push(e.local.stat(i)))}}}else for(f=0;f<s.length;f++)for(j=s[f].names(),g=0;g<j.length;g++)i=j[g],r[s[f].id+"."+i]=s[f].local.stat(i);r.remoteAddress&&v&&(r.remoteAddress=v),b(a,r)}):b({statistics:P.getConstantString("statsNotSupported")}):b({notConnected:a})},this.chromeStatsFilter=[{googTransmitBitrate:"transmitBitRate",googActualEncBitrate:"encodeRate",googAvailableSendBandwidth:"availableSendRate"},{googCodecName:"audioCodec",googTypingNoiseState:"typingNoise",packetsSent:"audioPacketsSent"},{googCodecName:"videoCodec",googFrameRateSent:"outFrameRate",packetsSent:"videoPacketsSent"},{packetsLost:"videoPacketsLost",packetsReceived:"videoPacketsReceived",googFrameRateOutput:"frameRateOut"},{packetsLost:"audioPacketsLost",packetsReceived:"audioPacketsReceived",audioOutputLevel:"audioOutputLevel"},{googRemoteAddress:"remoteAddress",googActiveConnection:"activeConnection"},{audioInputLevel:"audioInputLevel"}],this.firefoxStatsFilter={"outboundrtp_audio.packetsSent":"audioPacketsSent","outboundrtp_video.packetsSent":"videoPacketsSent","inboundrtp_video.packetsReceived":"videoPacketsReceived","inboundrtp_audio.packetsReceived":"audioPacketsReceived"},this.standardStatsFilter=Q?P.firefoxStatsFilter:P.chromeStatsFilter,this.setRoomApiField=function(a,c,d){if(P._roomApiFields||(P._roomApiFields={}),!c&&!d)return void delete P._roomApiFields[a];if(P._roomApiFields[a]||(P._roomApiFields[a]={}),d!==b&&null!==d){if("object"==typeof d)try{JSON.stringify(d)}catch(e){return void P.showError(P.errCodes.DEVELOPER_ERR,"easyrtc.setRoomApiField passed bad object ")}P._roomApiFields[a][c]={fieldName:c,fieldValue:d}}else delete P._roomApiFields[a][c];P.webSocketConnected&&h(a)};var pb=null;this.showError=function(a,b){P.onError({errorCode:a,errorText:b})},this.onError=function(a){P.debugPrinter&&P.debugPrinter("saw error "+a.errorText);var b,c=document.getElementById("easyrtcErrorDialog");if(!c){c=document.createElement("div"),c.id="easyrtcErrorDialog";var d=document.createElement("div");d.innerHTML="Error messages",d.className="easyrtcErrorDialog_title",c.appendChild(d),b=document.createElement("div"),b.id="easyrtcErrorDialog_body",c.appendChild(b);var e=document.createElement("button");e.appendChild(document.createTextNode("Okay")),e.className="easyrtcErrorDialog_okayButton",e.onclick=function(){b.innerHTML="",c.style.display="none"},c.appendChild(e),document.body.appendChild(c)}b=document.getElementById("easyrtcErrorDialog_body");var f=document.createElement("div");f.className="easyrtcErrorDialog_element",f.appendChild(document.createTextNode(a.errorText)),b.appendChild(f),c.style.display="block"},this.createObjectURL=function(a){var b;if(window.URL&&window.URL.createObjectURL)return window.URL.createObjectURL(a);if(window.webkitURL&&window.webkitURL.createObjectURL)return window.webkit.createObjectURL(a);throw b="Your browsers does not support URL.createObjectURL.",P.debugPrinter&&P.debugPrinter("saw exception "+b),b},this.cleanId=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;"};return a.replace(/[&<>]/g,function(a){return b[a]})},P.setRoomEntryListener=function(a){P.roomEntryListener=a},P.setRoomOccupantListener=function(a){gb=a},this.setDataChannelOpenListener=function(a){hb=a},this.setDataChannelCloseListener=function(a){ib=a},this.getConnectionCount=function(){var a,b=0;for(a in nb)nb.hasOwnProperty(a)&&P.getConnectStatus(a)===P.IS_CONNECTED&&b++;return b},this.enableAudio=function(a){$=a},this.enableVideo=function(a){_=a},this.enableDataChannels=function(a){eb=a},this.getLocalMediaIds=function(){return Object.keys(X)},this.closeLocalMediaStream=function(a){return p(a)},this.closeLocalStream=this.closeLocalMediaStream,this.enableCamera=function(a,b){var c=l(b);c&&c.getVideoTracks&&k(a,c.getVideoTracks())},this.enableMicrophone=function(a,b){var c=l(b);c&&c.getAudioTracks&&k(a,c.getAudioTracks())},P.muteVideoObject=function(a,b){var c;if("string"==typeof a){if(c=document.getElementById(a),!c)throw"Unknown video object "+a}else{if(!a)throw"muteVideoObject passed a null";c=a}c.muted=!!b},P.getLocalStreamAsUrl=function(a){var b=l(a);if(null===b)throw"Developer error: attempt to get a MediaStream without invoking easyrtc.initMediaSource successfully";return P.createObjectURL(b)},this.getLocalStream=function(a){return l(a)||null},this.clearMediaStream=function(a){"undefined"!=typeof a.srcObject?a.srcObject=null:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=null:"undefined"!=typeof a.src&&(a.src="")},this.setVideoObjectSrc=function(a,b){b&&""!==b?(a.autoplay=!0,d(a,b),a.play()):P.clearMediaStream(a)},this.buildLocalMediaStream=function(a,b,c){var d,e=[];if("string"!=typeof a)return void easyrtc.showError(this.errCodes.DEVELOPER_ERR,"easyrtc.buildLocalMediaStream not supplied a stream name");if(b)for(d=0;d<b.length;d++)e.push(b[d]);if(c)for(d=0;d<c.length;d++)e.push(c[d]);var f=new MediaStream(e);n(f,a)},this.loadStylesheet=function(){var a,b,c=document.getElementsByTagName("link");for(a in c)if(c.hasOwnProperty(a)&&(b=c[a],b.href&&b.href.match(/\/easyrtc.css/)))return;var d=document.createElement("link");d.setAttribute("rel","stylesheet"),d.setAttribute("type","text/css"),d.setAttribute("href","/easyrtc/easyrtc.css");var e=document.getElementsByTagName("head")[0],f=e.childNodes[0];e.insertBefore(d,f)},this.formatError=function(a){var b,c;if(null===a||"undefined"==typeof a)return"null";if("string"==typeof a)return a;if(a.type&&a.description)return a.type+" : "+a.description;if("object"!=typeof a)return"Strange case";try{return JSON.stringify(a)}catch(d){c="{";for(b in a)a.hasOwnProperty(b)&&"string"==typeof a[b]&&(c=c+b+"='"+a[b]+"' ");return c+="}"}},this.initMediaSource=function(a,b,d){function e(){return(new Date).getTime()}function f(a){var b=e();j+1e3>b?(console.log("Trying getUserMedia a second time"),setTimeout(function(){c(g,h,i)},3e3)):i(a)}if(P.debugPrinter&&P.debugPrinter("about to request local media"),d||(d="default"),U={audio:$,video:_},b||(b=function(a,b){var c="easyrtc.initMediaSource: "+P.formatError(b);P.debugPrinter&&P.debugPrinter(c),P.showError(P.errCodes.MEDIA_ERR,c)}),!P.supportsGetUserMedia())return void b(P.errCodes.MEDIA_ERR,P.getConstantString("noWebrtcSupport"));if(!a)return void P.showError(P.errCodes.DEVELOPER_ERR,"easyrtc.initMediaSource not supplied a successCallback");var g=P.getUserMediaConstraints(),h=function(b){P.debugPrinter&&P.debugPrinter("getUserMedia success callback entered"),P.debugPrinter&&P.debugPrinter("successfully got local media"),n(b,d);var c,e,f,g;U.video?(c=document.createElement("video"),c.muted=!0,e=30,f=function(){c.videoWidth>0||0>e?(P.nativeVideoWidth=c.videoWidth,P.nativeVideoHeight=c.videoHeight,!P._desiredVideoProperties.height||P.nativeVideoHeight===P._desiredVideoProperties.height&&P.nativeVideoWidth===P._desiredVideoProperties.width||P.showError(P.errCodes.MEDIA_WARNING,P.format(P.getConstantString("resolutionWarning"),P._desiredVideoProperties.width,P._desiredVideoProperties.height,P.nativeVideoWidth,P.nativeVideoHeight)),P.setVideoObjectSrc(c,""),c.removeNode?c.removeNode(!0):(g=document.createElement("div"),g.appendChild(c),g.removeChild(c)),mb(),a&&a(b)):(e-=1,setTimeout(f,300))},P.setVideoObjectSrc(c,b),f()):(mb(),a&&a(b))},i=function(a){console.log("getusermedia failed"),P.debugPrinter&&P.debugPrinter("failed to get local media");var c;c="string"==typeof a?a:a.name?a.name:"Unknown",b&&(console.log("invoking error callback",c),b(P.errCodes.MEDIA_ERR,P.format(P.getConstantString("gumFailed"),c))),p(d),U={audio:!1,video:!1},mb()};if(!$&&!_)return void i(P.getConstantString("requireAudioOrVideo"));var j;_||$?setTimeout(function(){try{j=e(),c(g,h,f)}catch(a){f(a)}},1e3):h(null)},this.setAcceptChecker=function(a){P.acceptCheck=a},this.setStreamAcceptor=function(a){P.streamAcceptor=a},P.setOnError=function(a){P.onError=a},this.setCallCancelled=function(a){P.callCancelled=a},this.setOnStreamClosed=function(a){P.onStreamClosed=a},this.setVideoBandwidth=function(){P.showError("easyrtc.setVideoBandwidth is deprecated, it no longer has an effect.")},this.supportsDataChannels=function(){return navigator.userAgent.match(/android/i)?g>=34:"firefox"===f||g>=32},this.setPeerListener=function(a,b,c){b?(kb.msgTypes[b]||(kb.msgTypes[b]={sources:{}}),c?kb.msgTypes[b].sources[c]={cb:a}:kb.msgTypes[b].cb=a):kb.cb=a},this.receivePeerDistribute=function(a,b,c){var d=b.msgType,e=b.msgData;if(!d)return void console.log("received peer message without msgType",b);if(kb.msgTypes[d]){if(kb.msgTypes[d].sources[a]&&kb.msgTypes[d].sources[a].cb)return void kb.msgTypes[d].sources[a].cb(a,d,e,c);if(kb.msgTypes[d].cb)return void kb.msgTypes[d].cb(a,d,e,c)}kb.cb&&kb.cb(a,d,e,c)},this.setServerListener=function(a){lb=a},this.setSocketUrl=function(a){P.debugPrinter&&P.debugPrinter("WebRTC signaling server URL set to "+a),fb=a},this.setUsername=function(a){return P.isNameValid(a)?(P.username=a,!0):(P.showError(P.errCodes.BAD_NAME,P.format(P.getConstantString("badUserName"),a)),!1)},this.usernameToIds=function(a,b){var c,d,e=[];for(d in jb)if(jb.hasOwnProperty(d)&&(!b||d===b))for(c in jb[d])jb[d].hasOwnProperty(c)&&jb[d][c].username===a&&e.push({easyrtcid:c,roomName:d});return e},this.getRoomApiField=function(a,c,d){return jb[a]&&jb[a][c]&&jb[a][c].apiField&&jb[a][c].apiField[d]?jb[a][c].apiField[d].fieldValue:b},this.setCredential=function(a){try{return JSON.stringify(a),db=a,!0}catch(b){throw P.showError(P.errCodes.BAD_CREDENTIAL,"easyrtc.setCredential passed a non-JSON-able object"),"easyrtc.setCredential passed a non-JSON-able object"}},this.setDisconnectListener=function(a){P.disconnectListener=a},this.idToName=function(a){var b;for(b in jb)if(jb.hasOwnProperty(b)&&jb[b][a]&&jb[b][a].username)return jb[b][a].username;return a},this.webSocket=null;var qb={},rb=null,sb=!1;this.setUseFreshIceEachPeerConnection=function(a){sb=a},this.getServerIce=function(){return qb},this.setIceUsedInCalls=function(a){a.iceServers?rb=a:easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"Bad ice configuration passed to easyrtc.setIceUsedInCalls")};var tb=null;this.haveAudioTrack=function(a,b){return q(a,!0,b)},this.haveVideoTrack=function(a,b){return q(a,!1,b)},this.getRoomField=function(a,c){var d=P.getRoomFields(a);return d&&d[c]?d[c].fieldValue:b},this.supportsStatistics=function(){var a;try{return a=new RTCPeerConnection({iceServers:[]},{}),!!a.getStats}catch(b){return!1}};var ub=null;this.disconnect=function(){P.debugPrinter&&P.debugPrinter("attempt to disconnect from WebRTC signalling server"),P.disconnecting=!0,P.hangupAll(),P.loggingOut=!0,setTimeout(function(){if(P.webSocket){try{P.webSocket.disconnect()
}catch(a){}tb=P.webSocket,P.webSocket=0}P.loggingOut=!1,P.disconnecting=!1,gb&&gb(null,{},!1),P.emitEvent("roomOccupant",{}),bb={}},250)},this.sendDataP2P=function(a,b,c){var d=JSON.stringify({msgType:b,msgData:c});if(P.debugPrinter&&P.debugPrinter("sending p2p message to "+a+" with data="+JSON.stringify(d)),nb[a])if(nb[a].dataChannelS)if(nb[a].dataChannelReady)try{nb[a].dataChannelS.send(d)}catch(e){throw console.log("error=",e),e}else P.showError(P.errCodes.DEVELOPER_ERR,"Attempt to use data channel to "+a+" before it's ready to send.");else P.showError(P.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without establishing a data channel to "+a+" first.");else P.showError(P.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without a connection to "+a+" first.")},this.sendDataWS=function(a,b,c,d){P.debugPrinter&&P.debugPrinter("sending client message via websockets to "+a+" with data="+JSON.stringify(c)),d||(d=function(a){"error"===a.msgType&&P.showError(a.msgData.errorCode,a.msgData.errorText)});var e={msgType:b,msgData:c};if(a&&("string"==typeof a?e.targetEasyrtcid=a:"object"==typeof a&&(a.targetEasyrtcid&&(e.targetEasyrtcid=a.targetEasyrtcid),a.targetRoom&&(e.targetRoom=a.targetRoom),a.targetGroup&&(e.targetGroup=a.targetGroup))),!P.webSocket)throw P.debugPrinter&&P.debugPrinter("websocket failed because no connection to server"),"Attempt to send message without a valid connection to the server.";P.webSocket.json.emit("easyrtcMsg",e,d)},this.sendData=function(a,b,c,d){nb[a]&&nb[a].dataChannelReady?P.sendDataP2P(a,b,c):P.sendDataWS(a,b,c,d)},this.sendPeerMessage=function(a,b,c,d,e){function f(a){"error"===a.msgType?e&&e(a.msgData.errorCode,a.msgData.errorText):d&&d(a.msgType,a.msgData?a.msgData:null)}a||console.error("Developer error, destination was null in sendPeerMessage"),P.debugPrinter&&P.debugPrinter("sending peer message "+JSON.stringify(c)),P.sendDataWS(a,b,c,f)},this.sendServerMessage=function(a,b,c,d){function e(a){"error"===a.msgType?d&&d(a.msgData.errorCode,a.msgData.errorText):c&&c(a.msgType,a.msgData?a.msgData:null)}if(P.debugPrinter){var f={msgType:a,msgData:b};P.debugPrinter("sending server message "+JSON.stringify(f))}P.sendDataWS(null,a,b,e)},this.getRoomList=function(a,b){t(null,"getRoomList",null,function(b,c){a(c.roomList)},function(a,c){b?b(a,c):P.showError(a,c)})},this.NOT_CONNECTED="not connected",this.BECOMING_CONNECTED="connection in progress to us.",this.IS_CONNECTED="is connected",this.getConnectStatus=function(a){if(!nb.hasOwnProperty(a))return P.NOT_CONNECTED;var b=nb[a];return!b.sharingAudio&&!b.sharingVideo||b.startedAV?b.sharingData&&!b.dataChannelReady?P.BECOMING_CONNECTED:P.IS_CONNECTED:P.BECOMING_CONNECTED},this.call=function(a,c,d,e,f){if(f)if("string"==typeof f)f=[f];else if(f.length===b)return void easyrtc.showError(P.errCodes.DEVELOPER_ERR,"easyrtc.call passed bad streamNames");if(P.debugPrinter&&P.debugPrinter("initiating peer to peer call to "+a+" audio="+$+" video="+_+" data="+eb),!P.supportsPeerConnections())return void d(P.errCodes.CALL_ERR,P.getConstantString("noWebrtcSupport"));var g;if(!f&&R){var h=P.getLocalStream();if(!h&&($||_))return void P.initMediaSource(function(){P.call(a,c,d,e)},d)}if(!P.webSocket)throw g="Attempt to make a call prior to connecting to service",P.debugPrinter&&P.debugPrinter(g),g;return cb[a]?(e(!0),wb(a,cb[a],f),delete cb[a],void P.callCancelled(a,!1)):"undefined"!=typeof ob[a]?(g="Call already pending acceptance",P.debugPrinter&&P.debugPrinter(g),void d(P.errCodes.ALREADY_CONNECTED,g)):void(sb?P.getFreshIceConfig(function(b){b?v(a,c,d,e,f):d(P.errCodes.CALL_ERR,"Attempt to get fresh ice configuration failed")}):v(a,c,d,e,f))},this.hangup=function(a){w(a),mb()},this.hangupAll=function(){var a=!1,b=function(){},c=function(a,b){P.debugPrinter&&P.debugPrinter("hangup failed:"+b)};for(var d in nb)nb.hasOwnProperty(d)&&(a=!0,w(d),P.webSocket&&t(d,"hangup",null,b,c));a&&mb()},this.doesDataChannelWork=function(a){return nb[a]?!!nb[a].dataChannelReady:!1},this.getRemoteStream=function(a,b){if(nb[a])return nb[a].getRemoteStreamByName(b);throw P.showError(P.errCodes.DEVELOPER_ERR,"attempt to get stream of uncalled party"),"Developer err: no such stream"},this.makeLocalStreamFromRemoteStream=function(a,b,c){streamName||(streamName="default");var d;if(!nb[a].pc)throw"Developer err: no such peer ";if(d=nb[a].getRemoteStreamByName(b),!d)throw"Developer err: no such stream";n(d,c)},this.addStreamToCall=function(a,b){console.log("adding stream with id "+b+" to call("+a+")");var c=l(b);if(c)if(nb[a]&&nb[a].pc){var d=nb[a].pc;d.addStream(c),d.createOffer(function(b){S&&(b.sdp=S(b.sdp)),d.setLocalDescription(b,function(){P.sendPeerMessage(a,"__addedMediaStream",{sdp:b})},function(){})},function(){console.log("unexpected error in creating offer")})}else console.log("Can't add stream before a call has started.");else console.log("attempt to add nonexistent stream "+b)},this.setPeerListener(function(a,b,c){if(nb[a]&&nb[a].pc){var d=c.sdp,e=nb[a].pc;T&&(d.sdp=T(d.sdp)),e.setRemoteDescription(new RTCSessionDescription(d)),e.createAnswer(function(b){S&&(b.sdp=S(b.sdp)),e.setLocalDescription(b,function(){P.sendPeerMessage(a,"__gotAddedMediaStream",{sdp:b})},function(){})},function(){console.log("unexpected error creating answer")})}else easyrtc.showError(P.errCodes.DEVELOPER_ERR,"Attempt to add additional stream before establising the base call.")},"__addedMediaStream"),this.setPeerListener(function(a,b,c){if(nb[a]&&nb[a].pc){var d=c.sdp;T&&(d.sdp=T(d.sdp));var e=nb[a].pc;e.setRemoteDescription(new RTCSessionDescription(d))}else;},"__gotAddedMediaStream"),this.setPeerListener(function(a,b,c){if(nb[a]&&nb[a].pc){var d=nb[a].getRemoteStreamByName(c.streamName);d&&x(a,d,c.streamName)}else;},"__closingMediaStream"),this.dumpPeerConnectionInfo=function(){for(var a in nb){console.log("For peer "+a);for(var b=nb[a].pc,c=b.getRemoteStreams(),d=[],e=0;e<c.length;e++)d.push(c[e].id);for(var f=b.getLocalStreams(),g=[],e=0;e<f.length;e++)g.push(f[e].id);console.log("    "+JSON.stringify({local:g,remote:d}))}};var vb=function(a,b,c,d){function e(b){if(P.debugPrinter&&P.debugPrinter("saw dataChannel.onmessage event: "+JSON.stringify(b.data)),"dataChannelPrimed"===b.data)P.sendDataWS(a,"dataChannelPrimed","");else try{var c=JSON.parse(b.data);c&&P.receivePeerDistribute(a,c,null)}catch(d){}}function f(a){P.debugPrinter&&P.debugPrinter("saw initOutgoingChannel call");var b=h.createDataChannel(ab,P.getDatachannelConstraints());nb[a].dataChannelS=b,nb[a].dataChannelR=b,b.onmessage=e,b.onopen=function(){P.debugPrinter&&P.debugPrinter("saw dataChannel.onopen event"),nb[a]&&b.send("dataChannelPrimed")},b.onclose=function(){P.debugPrinter&&P.debugPrinter("saw dataChannelS.onclose event"),nb[a]&&(nb[a].dataChannelReady=!1,delete nb[a].dataChannelS),ib&&ib(a),mb()}}function g(a){P.debugPrinter&&P.debugPrinter("initializing incoming channel handler for "+a),nb[a].pc.ondatachannel=function(b){P.debugPrinter&&P.debugPrinter("saw incoming data channel");var c=b.channel;nb[a].dataChannelR=c,nb[a].dataChannelS=c,nb[a].dataChannelReady=!0,c.onmessage=e,c.onclose=function(){P.debugPrinter&&P.debugPrinter("saw dataChannelR.onclose event"),nb[a]&&(nb[a].dataChannelReady=!1,delete nb[a].dataChannelR),ib&&ib(a),mb()},c.onopen=function(){P.debugPrinter&&P.debugPrinter("saw dataChannel.onopen event"),nb[a]&&c.send("dataChannelPrimed")}}}var h,i,j,k=rb?rb:qb;P.debugPrinter&&P.debugPrinter("building peer connection to "+a);try{if(h=P.createRTCPeerConnection(k,u()),!h)throw i="Unable to create PeerConnection object, check your ice configuration("+JSON.stringify(ice_config)+")",P.debugPrinter&&P.debugPrinter(i),i;eb&&"undefined"==typeof h.createDataChannel&&(eb=!1),h.onconnection=function(){P.debugPrinter&&P.debugPrinter("onconnection called prematurely")},j={pc:h,candidatesToSend:[],startedAV:!1,connectionAccepted:!1,isInitiator:b,remoteStreamIdToName:{},getRemoteStreamByName:function(b){var c,d=h.getRemoteStreams(),e=0,f=null;if(b||(b="default"),"default"===b)return d.length>0?d[0]:null;for(c in P.roomData){var g=P.getRoomApiField(c,a,"mediaIds");if(f=g?g[b]:null)break}for(f||P.showError(P.errCodes.DEVELOPER_ERR,"remote peer does not have media stream called "+b),e=0;e<d.length;e++){var i;if(i=d[e].hasOwnProperty("id")?d[e].id:"anonymous",!f||i===f)return d[e]}return null}},h.onicecandidate=function(b){if(!j.cancelled){var d;if(b.candidate&&nb[a]){if(d={type:"candidate",label:b.candidate.sdpMLineIndex,id:b.candidate.sdpMid,candidate:b.candidate.candidate},b.candidate.candidate.indexOf("typ relay")>0){var e=b.candidate.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[2];P._turnServers[e]=!0}nb[a].connectionAccepted?t(a,"candidate",d,null,function(){c(P.errCodes.PEER_GONE,"Candidate disappeared")}):nb[a].candidatesToSend.push(d)}}},h.onaddstream=function(b){if(P.debugPrinter&&P.debugPrinter("saw incoming media stream"),!j.cancelled){nb[a].startedAV||(nb[a].startedAV=!0,nb[a].sharingAudio=U.audio,nb[a].sharingVideo=U.video,nb[a].connectTime=(new Date).getTime(),nb[a].callSuccessCB&&(nb[a].sharingAudio||nb[a].sharingVideo)&&nb[a].callSuccessCB(a,"audiovideo"),($||_)&&H());var c=o(a,b.stream.id||"anonymous");c||(c="default"),nb[a].remoteStreamIdToName[b.stream.id||"anonymous"]=c,P.streamAcceptor&&P.streamAcceptor(a,b.stream,c)}},h.onremovestream=function(b){P.debugPrinter&&P.debugPrinter("saw remove on remote media stream"),x(a,b.stream,b.stream.id||"anonymous")},nb[a]=j}catch(m){return P.debugPrinter&&P.debugPrinter(JSON.stringify(m)),c(P.errCodes.SYSTEM_ERR,m.message),null}var n,p;if(d)for(n=0;n<d.length;n++)p=l(d[n]),p?h.addStream(p):console.log("Developer error, attempt to access unknown local media stream "+d[n]);else R&&(_||$)&&(p=P.getLocalStream(),h.addStream(p));var q=eb;if(q){if(P.setPeerListener(function(){nb[a].dataChannelReady=!0,nb[a].callSuccessCB&&nb[a].callSuccessCB(a,"datachannel"),hb&&hb(a,!0),mb()},"dataChannelPrimed",a),b)try{f(a)}catch(r){console.log("failed to init outgoing channel"),c(P.errCodes.SYSTEM_ERR,P.formatError(r))}b||g(a)}return h.onconnection=function(){P.debugPrinter&&P.debugPrinter("setup pc.onconnection ")},h},wb=function(a,b,c){if(!c&&R){var d=P.getLocalStream();if(!d&&(_||$))return void P.initMediaSource(function(){wb(a,b)},function(){P.showError(P.errCodes.MEDIA_ERR,P.format(P.getConstantString("localMediaError")))})}sb?P.getFreshIceConfig(function(d){d?xb(a,b,c):P.showError(P.errCodes.CALL_ERR,"Failed to get fresh ice config")}):xb(a,b,c)},xb=function(a,b,c){var d=vb(a,!1,function(a){P.showError(P.errCodes.SYSTEM_ERR,a)},c),e=nb[a];if(!d)return void(P.debugPrinter&&P.debugPrinter("buildPeerConnection failed. Call not answered"));var f=function(b){if(!e.cancelled){var c=function(){function c(){}function e(b,c){delete nb[a],P.showError(b,c)}P.debugPrinter&&P.debugPrinter("sending answer"),t(a,"answer",b,c,e),nb[a].connectionAccepted=!0,C(a,c,e),d.connectDataConnection&&(P.debugPrinter&&P.debugPrinter("calling connectDataConnection(5002,5001)"),d.connectDataConnection(5002,5001))};S&&(b.sdp=S(b.sdp)),d.setLocalDescription(b,c,function(a){P.showError(P.errCodes.INTERNAL_ERR,"setLocalDescription: "+a)})}},g=null;g=window.mozRTCSessionDescription?new mozRTCSessionDescription(b):new RTCSessionDescription(b),P.debugPrinter&&P.debugPrinter("sdp ||  "+JSON.stringify(g));var h=function(){e.cancelled||d.createAnswer(f,function(a){P.showError(P.errCodes.INTERNAL_ERR,"create-answer: "+a)},Z)};P.debugPrinter&&P.debugPrinter("about to call setRemoteDescription in doAnswer");try{T&&(g.sdp=T(g.sdp)),d.setRemoteDescription(g,h,function(a){P.showError(P.errCodes.INTERNAL_ERR,"set-remote-description: "+a)})}catch(i){console.log("set remote description failed"),P.debugPrinter&&P.debugPrinter("saw exception in setRemoteDescription"),P.showError(P.errCodes.INTERNAL_ERR,"setRemoteDescription failed: "+i.message)}},yb=function(a){if(delete cb[a],P.debugPrinter&&P.debugPrinter("Saw onRemote hangup event"),nb[a]){if(nb[a].cancelled=!0,nb[a].pc){var b=nb[a].pc.getRemoteStreams();if(b){var c;for(c=0;c<b.length;c++){y(a,b[c]);try{b[c].stop()}catch(d){}}}try{nb[a].pc.close()}catch(e){}}else P.callCancelled&&P.callCancelled(a,!0);delete nb[a],mb()}else P.callCancelled&&P.callCancelled(a,!0)},zb={},Ab=function(a){zb[a]={candidates:[]}},Bb=function(a,b){var c={};b&&b(P.ackMessage),a.targetEasyrtcid&&(c.targetEasyrtcid=a.targetEasyrtcid),a.targetRoom&&(c.targetRoom=a.targetRoom),a.targetGroup&&(c.targetGroup=a.targetGroup),a.senderEasyrtcid?P.receivePeerDistribute(a.senderEasyrtcid,a,c):lb?lb(a.msgType,a.msgData,c):console.log("Unhandled server message "+JSON.stringify(a))},Cb=function(a,c){function d(a){delete ob[a],zb[a]&&delete zb[a],nb[a]&&(nb[a].wasAcceptedCB&&nb[a].wasAcceptedCB(!1,a),delete nb[a])}function e(a,b){if(delete ob[a],nb[a].connectionAccepted=!0,nb[a]){nb[a].wasAcceptedCB&&nb[a].wasAcceptedCB(!0,a);var c=function(){},d=function(b,c){nb[a]&&delete nb[a],P.showError(b,c)};C(a,c,d),g=nb[a].pc;var e=null;if(e=window.mozRTCSessionDescription?new mozRTCSessionDescription(b):new RTCSessionDescription(b),!e)throw"Could not create the RTCSessionDescription";P.debugPrinter&&P.debugPrinter("about to call initiating setRemoteDescription");try{T&&(e.sdp=T(e.sdp)),g.setRemoteDescription(e,function(){g.connectDataConnection&&(P.debugPrinter&&P.debugPrinter("calling connectDataConnection(5001,5002)"),g.connectDataConnection(5001,5002))})}catch(f){console.log("setRemoteDescription failed ",f)}l(a)}}function f(a,b){nb[a]&&nb[a].pc?k(a,b):(nb[a]||(zb[a]={candidates:[]}),zb[a].candidates.push(b))}var g,h=a.senderEasyrtcid,i=a.msgType,j=a.msgData;P.debugPrinter&&P.debugPrinter("received message of type "+i),"undefined"==typeof zb[h]&&Ab(h);var k=function(a,b){var c=null;if(c=window.mozRTCIceCandidate?new mozRTCIceCandidate({sdpMLineIndex:b.label,candidate:b.candidate}):new RTCIceCandidate({sdpMLineIndex:b.label,candidate:b.candidate}),g=nb[a].pc,g.addIceCandidate(c),b.candidate.indexOf("typ relay")>0){var d=b.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[1];P._turnServers[d]=!0}},l=function(a){var b;if(zb[a]){for(b=0;b<zb[a].candidates.length;b++)k(a,zb[a].candidates[b]);delete zb[a]}},m=function(a,c){var d=function(d,e){if(e)if("string"==typeof e)e=[e];else if(e.length===b)return void easyrtc.showError(P.errCodes.DEVELOPER_ERR,"accept callback passed invalid streamNames");return P.debugPrinter&&P.debugPrinter("offer accept="+d),delete cb[a],P.supportsPeerConnections()?void(d?(wb(a,c,e),l(a)):(t(a,"reject",null,null,null),Ab(a))):void callFailureCB(P.errCodes.CALL_ERR,P.getConstantString("noWebrtcSupport"))};return ob[a]&&a<P.myEasyrtcid?(delete ob[a],zb[a]&&delete zb[a],nb[a].wasAcceptedCB&&nb[a].wasAcceptedCB(!0,a),delete nb[a],void d(!0)):(cb[a]=c,void(P.acceptCheck?P.acceptCheck(a,d):d(!0)))};switch(i){case"sessionData":I(j.sessionData);break;case"roomData":J(j.roomData);break;case"iceConfig":K(j.iceConfig);break;case"forwardToUrl":j.newWindow?window.open(j.forwardToUrl.url):window.location.href=j.forwardToUrl.url;break;case"offer":m(h,j);break;case"reject":d(h);break;case"answer":e(h,j);break;case"candidate":f(h,j);break;case"hangup":yb(h),Ab(h);break;case"error":P.showError(a.errorCode,a.errorText);break;default:return void console.error("received unknown message type from server, msgType is "+i)}c&&c(P.ackMessage)};mb=function(){H()},this.updatePresence=function(a,b){P.presenceShow=a,P.presenceStatus=b,P.webSocketConnected&&t(null,"setPresence",{setPresence:{show:a,status:b}},null)},this.getSessionFields=function(){return Y},this.getSessionField=function(a){return Y[a]?Y[a].fieldValue:b},this.getRoomOccupantsAsArray=function(a){return jb[a]?Object.keys(jb[a]):null},this.getRoomOccupantsAsMap=function(a){return jb[a]},this.isTurnServer=function(a){return!!P._turnServers[a]},this.getFreshIceConfig=function(a){var b={msgType:"getIceConfig",msgData:{}};a||(a=function(){}),P.webSocket.json.emit("easyrtcCmd",b,function(b){"iceConfig"===b.msgType?(K(b.msgData.iceConfig),a(!0)):(P.showError(b.msgData.errorCode,b.msgData.errorText),a(!1))})},this.getRoomsJoined=function(){var a,b={};for(a in P.roomJoin)P.roomJoin.hasOwnProperty(a)&&(b[a]=!0);return b},this.getRoomFields=function(a){return ub&&ub.rooms&&ub.rooms[a]?ub.rooms[a]:b},this.getApplicationFields=function(){return ub.application},this.getConnectionFields=function(){return ub.connection};var Db=!0;this.dontAddCloseButtons=function(){Db=!1},this.easyApp=function(a,b,c,d,e){function f(){function c(a,b){h?h(!1,b):e?e(P.errCodes.CONNECT_ERR,b):P.showError(P.errCodes.CONNECT_ERR,b)}g&&g(!0,null),null!==b&&P.setVideoObjectSrc(document.getElementById(b),P.getLocalStream()),P.connect(a,i,c)}var g=null,h=null;O(b,c),P.setGotMedia=function(a){g=a},P.setGotConnection=function(a){h=a};var i;i=function(){h&&h(!0,""),d(P.myEasyrtcid)};var j=l(null);j?f():P.initMediaSource(f,function(a,b){g?g(!1,b):e?e(P.errCodes.MEDIA_ERR,b):P.showError(P.errCodes.MEDIA_ERR,b)},null)},this.initManaged=this.easyApp;var Eb=null;this.useThisSocketConnection=function(a){Eb=a},this.connect=function(a,b,c){return window.io||P.showError("Developer error","Your HTML has not included the socket.io.js library"),!Eb&&P.webSocket?void console.error("Developer error: attempt to connect when already connected to socket server"):(qb={},tb=null,bb={},zb={},P.applicationName=a,ub={rooms:{},application:{},connection:{}},P.debugPrinter&&P.debugPrinter("attempt to connect to WebRTC signalling server with application name="+a),null===c&&(c=function(a,b){console.error("easyrtc.connect: "+b)}),void D(b,c))}},j={unableToEnterRoom:"Unable to enter room {0} because {1}",resolutionWarning:"Requested video size of {0}x{1} but got size of {2}x{3}",badUserName:"Illegal username {0}",localMediaError:"Error getting local media stream: {0}",miscSignalError:"Miscellaneous error from signalling server. It may be ignorable.",noServer:"Unable to reach the EasyRTC signalling server.",badsocket:"Socket.io connect event fired with bad websocket.",icf:"Internal communications failure",statsNotSupported:"call statistics not supported by this browser, try Chrome.",noWebrtcSupport:"Your browser doesn't appear to support WebRTC.",gumFailed:"Failed to get access to local media. Error code was {0}.",requireAudioOrVideo:"At least one of audio and video must be provided"};return new i});
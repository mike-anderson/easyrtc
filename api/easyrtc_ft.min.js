/*! easyrtc 1.0.12 Copyright (c) 2014, Priologic Software Inc. All rights reserved. */
!function(a){if("function"==typeof define&&define.amd)define(["socket.io"],a);else if("object"==typeof exports&&exports){var b=require("socket.io");module.exports=a(b,adapter)}else{if("object"!=typeof window.io||!window.io)throw new Error("EasyRTC requires socket.io \nhttp://easyrtc.com/docs/guides/easyrtc_client_tutorial.php");window.easyrtc=a(window.io)}}(function(){var a={};return a.buildDragNDropRegion=function(a,b){function c(a){return a.stopPropagation(),a.preventDefault(),!1}function d(a){return a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="copy",!1}function e(a){i(j,k);var d=a.dataTransfer,e=d.files;if(d.files.length>0)try{b(e)}catch(f){console.log("dragndrop errorEvent",f)}return c(a)}function f(a){return h(j,k),d(a)}function g(a){return i(j,k),d(a)}function h(a,b){if(a.className){if(a.className.indexOf(b,0)>=0)return;a.className=a.className+" "+b}else a.className=b;a.className=a.className.replace("  "," ")}function i(a,b){a.className&&(a.className=a.className.replace(b,"").replace("  "," "))}var j;if("string"==typeof a){if(j=document.getElementById(a),!j)throw alert("Developer error: attempt to call BuildFileSender on unknown object "+a),"unknown object "+a}else j=a;var k="easyrtcfiledrop",l=function(){return document.addEventListener?function(a,b,c){if(a&&a.nodeName||a===window)a.addEventListener(b,c,!1);else if(a&&a.length)for(var d=0;d<a.length;d++)l(a[d],b,c)}:function(a,b,c){if(a&&a.nodeName||a===window)a.attachEvent("on"+b,function(){return c.call(a,window.event)});else if(a&&a.length)for(var d=0;d<a.length;d++)l(a[d],b,c)}}();j.ondrop=e,j.ondragenter=f,j.ondragleave=g,j.ondragover=d},a.buildFileSender=function(a,b){function c(a,c,d){d.seq&&(delete o[d.seq],b({status:"rejected"}),o.length=0,h())}function d(a,b,c){if(c.seq&&o[c.seq]){for(var d=p.length>0,e=0;e<o[c.seq].length;e++)p.push(o[c.seq][e]);delete o[c.seq],d||(n=0,g())}}function e(){p.empty(),b({status:"cancelled"}),o.length=0,p.length=0,q=!1,h()}function f(a,b,c){m=c.positionAck,t&&m+u>n&&(t=!1,g())}function g(){if(!r){if(0===p.length)return y=0,easyrtc.sendData(a,"filesChunk",{done:"all"}),o.length=0,b({status:"done"}),void h();r=p.pop(),b({status:"started_file",name:r.name}),j=r.size,m=0,t=!1,easyrtc.sendData(a,"filesChunk",{name:r.name,type:r.type,outseq:y,size:r.size}),y++}var c=Math.min(s,j-n);if(!b({status:"working",name:r.name,position:n,size:j,numFiles:p.length+1}))return o.length=0,n=0,easyrtc.sendData(a,"filesChunk",{done:"cancelled"}),void h();var d=n+c,e=r.slice(n,d),f=new FileReader;f.onloadend=function(b){if(b.target.readyState===FileReader.DONE){for(var e=b.target.result,f=32,h=32,i=0;i<e.length;i++){var l=e.charCodeAt(i);f=Math.max(f,l),h=Math.min(h,l)}for(var o=400,p=0;p<e.length;p+=o){var q=Math.min(o,c-p),r=e.substring(p,p+q),s={outseq:y};k?s.data64=btoa(r):s.datatxt=r,easyrtc.sendData(a,"filesChunk",s),y++}d>=j&&easyrtc.sendData(a,"filesChunk",{done:"file"}),m+u>n?g():t=!0}},f.readAsBinaryString(e),n=d,d>=j&&(r=null,n=0)}function h(){w=!1,v.length>0&&setTimeout(function(){var a=v.pop();i(a.files,a.areBinary)},240)}function i(c,d){if(w)v.push({files:c,areBinary:d});else{w=!0,k=d,b({status:"waiting"});for(var e=[],f=0;f<c.length;f++)e[f]={name:c[f].name,size:c[f].size};l++,o[l]=c,easyrtc.sendDataWS(a,"filesOffer",{seq:l,fileNameList:e})}}var j,k,l=0,m=0,n=0,o=[],p=[],q=!1,r=null,s=10240,t=!1,u=102400,v=[],w=!1;b||(b=function(){return!0});var x=function(c,d){var e,f=!1;for(e in d)d[e][a]&&(f=!0);f||(easyrtc.removeEventListener("roomOccupant",x),(p.length>0||o.length>0)&&b({status:"cancelled"}))};easyrtc.addEventListener("roomOccupant",x),easyrtc.setPeerListener(c,"filesReject",a),easyrtc.setPeerListener(d,"filesAccept",a),easyrtc.setPeerListener(e,"filesCancel",a),easyrtc.setPeerListener(f,"filesAck",a);var y=0;return i},a.buildFileReceiver=function(a,b,c){function d(b,d,e){f[b]||(f[b]={}),a(b,e.fileNameList,function(a){var d=function(a){"error"===a.msgType?(c(b,{status:"done",reason:"accept_failed"}),delete f[b]):c(b,{status:"started"})};a?(f[b]={groupSeq:e.seq,nextPacketSeq:0},easyrtc.sendDataWS(b,"filesAccept",{seq:e.seq},d)):(easyrtc.sendDataWS(b,"filesReject",{seq:e.seq}),delete f[b],c(b,{status:"rejected"}))})}function e(a,d,e){var i,j=f[a];if(j)if(e.done)switch(e.done){case"file":var k=new Blob(j.currentData,{type:j.currentFileType});b(a,k,j.currentFileName),c(a,{status:"eof",name:j.currentFileName}),k=null,h=0,j.currentData=[];break;case"all":c(a,{status:"done",reason:"success"});break;case"cancelled":delete f[a],c(a,{status:"done",reason:"cancelled"})}else if(e.name)c(a,{status:"started_file",name:e.name}),j.currentFileName=e.name,j.currentFileType=e.type,j.lengthReceived=0,j.lengthExpected=e.size,j.currentData=[];else if(e.data64||e.datatxt){var l;l=e.data64?atob(e.data64):e.datatxt;var m=l.length,n=new Uint8Array(m);for(i=0;m>i;i+=1)n[i]=l.charCodeAt(i);j.lengthReceived+=m,j.currentData||console.log("Lost my currentData!!!"),j.currentData.push(n),c(a,{status:"progress",name:j.currentFileName,received:j.lengthReceived,size:j.lengthExpected}),j.lengthReceived>h+g&&(h=j.lengthReceived,easyrtc.sendData(a,"filesAck",{positionAck:h}))}else console.log("Unexpected data structure in filesChunk=",e)}var f={},g=1e4,h=0,i=function(a,b){var d,e;for(destUser in f){d=!1;for(e in b)b[e][destUser]&&(d=!0);d||(easyrtc.removeEventListener("roomOccupant",i),c(destUser,{status:"done",reason:"cancelled"}),delete f[destUser])}};easyrtc.addEventListener("roomOccupant",i),easyrtc.setPeerListener(d,"filesOffer"),easyrtc.setPeerListener(e,"filesChunk")},a.saveAs=function(){var a=window.saveAs||navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=a.URL||a.webkitURL||a,e=b.createElementNS("http://www.w3.org/1999/xhtml","a"),f=!a.externalHost&&"download"in e,g=function(c){var d=b.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)},h=a.webkitRequestFileSystem,i=a.requestFileSystem||h||a.mozRequestFileSystem,j=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},k="application/octet-stream",l=0,m=[],n=function(){for(var a=m.length;a--;){var b=m[a];"string"==typeof b?d.revokeObjectURL(b):b.remove()}m.length=0},o=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){j(f)}}},p=function(b,d){var j,n,p,q=this,r=b.type,s=!1,t=function(){var a=c().createObjectURL(b);return m.push(a),a},u=function(){o(q,"writestart progress write writeend".split(" "))},v=function(){(s||!j)&&(j=t(b)),n?n.location.href=j:window.open(j,"_blank"),q.readyState=q.DONE,u()},w=function(a){return function(){return q.readyState!==q.DONE?a.apply(this,arguments):null}},x={create:!0,exclusive:!1};return q.readyState=q.INIT,d||(d="download"),f?(j=t(b),e.href=j,e.download=d,g(e),q.readyState=q.DONE,void u()):(a.chrome&&r&&r!==k&&(p=b.slice||b.webkitSlice,b=p.call(b,0,b.size,k),s=!0),h&&"download"!==d&&(d+=".download"),(r===k||h)&&(n=a),i?(l+=b.size,void i(a.TEMPORARY,l,w(function(a){a.root.getDirectory("saved",x,w(function(a){var c=function(){a.getFile(d,x,w(function(a){a.createWriter(w(function(c){c.onwriteend=function(b){n.location.href=a.toURL(),m.push(a),q.readyState=q.DONE,o(q,"writeend",b)},c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=q["on"+a]}),c.write(b),q.abort=function(){c.abort(),q.readyState=q.DONE},q.readyState=q.WRITING}),v)}),v)};a.getFile(d,{create:!1},w(function(a){a.remove(),c()}),w(function(a){a.code===a.NOT_FOUND_ERR?c():v()}))}),v)}),v)):void v())},q=p.prototype,r=function(a,b){return new p(a,b)};return q.abort=function(){var a=this;a.readyState=a.DONE,o(a,"abort")},q.readyState=q.INIT=0,q.WRITING=1,q.DONE=2,q.error=q.onwritestart=q.onprogress=q.onwrite=q.onabort=q.onerror=q.onwriteend=null,a.addEventListener("unload",n,!1),r}(self);return a}(),new Easyrtc});
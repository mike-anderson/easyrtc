/*! easyrtc 1.0.12 Copyright (c) 2014, Priologic Software Inc. All rights reserved. */
!function(a){if("function"==typeof define&&define.amd)define(["./easyrtc"],a);else if("object"==typeof exports&&exports){var b=require("./easyrtc");module.exports=a(b)}else{if("object"!=typeof window.easyrtc||!window.io)throw new Error("EasyRTC File Transfer requires EasyRTC \nhttp://easyrtc.com/docs/guides/easyrtc_client_tutorial.php");window.easyrtc_ft=a(window.easyrtc)}}(function(a){var b={};return b.buildDragNDropRegion=function(a,b){function c(a){return a.stopPropagation(),a.preventDefault(),!1}function d(a){return a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="copy",!1}function e(a){i(j,k);var d=a.dataTransfer,e=d.files;if(d.files.length>0)try{b(e)}catch(f){console.log("dragndrop errorEvent",f)}return c(a)}function f(a){return h(j,k),d(a)}function g(a){return i(j,k),d(a)}function h(a,b){if(a.className){if(a.className.indexOf(b,0)>=0)return;a.className=a.className+" "+b}else a.className=b;a.className=a.className.replace("  "," ")}function i(a,b){a.className&&(a.className=a.className.replace(b,"").replace("  "," "))}var j;if("string"==typeof a){if(j=document.getElementById(a),!j)throw alert("Developer error: attempt to call BuildFileSender on unknown object "+a),"unknown object "+a}else j=a;var k="easyrtcfiledrop",l=function(){return document.addEventListener?function(a,b,c){if(a&&a.nodeName||a===window)a.addEventListener(b,c,!1);else if(a&&a.length)for(var d=0;d<a.length;d++)l(a[d],b,c)}:function(a,b,c){if(a&&a.nodeName||a===window)a.attachEvent("on"+b,function(){return c.call(a,window.event)});else if(a&&a.length)for(var d=0;d<a.length;d++)l(a[d],b,c)}}();j.ondrop=e,j.ondragenter=f,j.ondragleave=g,j.ondragover=d},b.buildFileSender=function(b,c){function d(a,b,d){d.seq&&(delete p[d.seq],c({status:"rejected"}),p.length=0,i())}function e(a,b,c){if(c.seq&&p[c.seq]){for(var d=q.length>0,e=0;e<p[c.seq].length;e++)q.push(p[c.seq][e]);delete p[c.seq],d||(o=0,h())}}function f(){q.empty(),c({status:"cancelled"}),p.length=0,q.length=0,r=!1,i()}function g(a,b,c){n=c.positionAck,u&&n+v>o&&(u=!1,h())}function h(){if(!s){if(0===q.length)return z=0,a.sendData(b,"filesChunk",{done:"all"}),p.length=0,c({status:"done"}),void i();s=q.pop(),c({status:"started_file",name:s.name}),k=s.size,n=0,u=!1,a.sendData(b,"filesChunk",{name:s.name,type:s.type,outseq:z,size:s.size}),z++}var d=Math.min(t,k-o);if(!c({status:"working",name:s.name,position:o,size:k,numFiles:q.length+1}))return p.length=0,o=0,a.sendData(b,"filesChunk",{done:"cancelled"}),void i();var e=o+d,f=s.slice(o,e),g=new FileReader;g.onloadend=function(c){if(c.target.readyState===FileReader.DONE){for(var f=c.target.result,g=32,i=32,j=0;j<f.length;j++){var m=f.charCodeAt(j);g=Math.max(g,m),i=Math.min(i,m)}for(var p=400,q=0;q<f.length;q+=p){var r=Math.min(p,d-q),s=f.substring(q,q+r),t={outseq:z};l?t.data64=btoa(s):t.datatxt=s,a.sendData(b,"filesChunk",t),z++}e>=k&&a.sendData(b,"filesChunk",{done:"file"}),n+v>o?h():u=!0}},g.readAsBinaryString(f),o=e,e>=k&&(s=null,o=0)}function i(){x=!1,w.length>0&&setTimeout(function(){var a=w.pop();j(a.files,a.areBinary)},240)}function j(d,e){if(x)w.push({files:d,areBinary:e});else{x=!0,l=e,c({status:"waiting"});for(var f=[],g=0;g<d.length;g++)f[g]={name:d[g].name,size:d[g].size};m++,p[m]=d,a.sendDataWS(b,"filesOffer",{seq:m,fileNameList:f})}}var k,l,m=0,n=0,o=0,p=[],q=[],r=!1,s=null,t=10240,u=!1,v=102400,w=[],x=!1;c||(c=function(){return!0});var y=function(d,e){var f,g=!1;for(f in e)e[f][b]&&(g=!0);g||(a.removeEventListener("roomOccupant",y),(q.length>0||p.length>0)&&c({status:"cancelled"}))};a.addEventListener("roomOccupant",y),a.setPeerListener(d,"filesReject",b),a.setPeerListener(e,"filesAccept",b),a.setPeerListener(f,"filesCancel",b),a.setPeerListener(g,"filesAck",b);var z=0;return j},b.buildFileReceiver=function(b,c,d){function e(c,e,f){g[c]||(g[c]={}),b(c,f.fileNameList,function(b){var e=function(a){"error"===a.msgType?(d(c,{status:"done",reason:"accept_failed"}),delete g[c]):d(c,{status:"started"})};b?(g[c]={groupSeq:f.seq,nextPacketSeq:0},a.sendDataWS(c,"filesAccept",{seq:f.seq},e)):(a.sendDataWS(c,"filesReject",{seq:f.seq}),delete g[c],d(c,{status:"rejected"}))})}function f(b,e,f){var j,k=g[b];if(k)if(f.done)switch(f.done){case"file":var l=new Blob(k.currentData,{type:k.currentFileType});c(b,l,k.currentFileName),d(b,{status:"eof",name:k.currentFileName}),l=null,i=0,k.currentData=[];break;case"all":d(b,{status:"done",reason:"success"});break;case"cancelled":delete g[b],d(b,{status:"done",reason:"cancelled"})}else if(f.name)d(b,{status:"started_file",name:f.name}),k.currentFileName=f.name,k.currentFileType=f.type,k.lengthReceived=0,k.lengthExpected=f.size,k.currentData=[];else if(f.data64||f.datatxt){var m;m=f.data64?atob(f.data64):f.datatxt;var n=m.length,o=new Uint8Array(n);for(j=0;n>j;j+=1)o[j]=m.charCodeAt(j);k.lengthReceived+=n,k.currentData||console.log("Lost my currentData!!!"),k.currentData.push(o),d(b,{status:"progress",name:k.currentFileName,received:k.lengthReceived,size:k.lengthExpected}),k.lengthReceived>i+h&&(i=k.lengthReceived,a.sendData(b,"filesAck",{positionAck:i}))}else console.log("Unexpected data structure in filesChunk=",f)}var g={},h=1e4,i=0,j=function(b,c){var e,f;for(destUser in g){e=!1;for(f in c)c[f][destUser]&&(e=!0);e||(a.removeEventListener("roomOccupant",j),d(destUser,{status:"done",reason:"cancelled"}),delete g[destUser])}};a.addEventListener("roomOccupant",j),a.setPeerListener(e,"filesOffer"),a.setPeerListener(f,"filesChunk")},b.saveAs=function(){var a=window.saveAs||navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=a.URL||a.webkitURL||a,e=b.createElementNS("http://www.w3.org/1999/xhtml","a"),f=!a.externalHost&&"download"in e,g=function(c){var d=b.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)},h=a.webkitRequestFileSystem,i=a.requestFileSystem||h||a.mozRequestFileSystem,j=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},k="application/octet-stream",l=0,m=[],n=function(){for(var a=m.length;a--;){var b=m[a];"string"==typeof b?d.revokeObjectURL(b):b.remove()}m.length=0},o=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){j(f)}}},p=function(b,d){var j,n,p,q=this,r=b.type,s=!1,t=function(){var a=c().createObjectURL(b);return m.push(a),a},u=function(){o(q,"writestart progress write writeend".split(" "))},v=function(){(s||!j)&&(j=t(b)),n?n.location.href=j:window.open(j,"_blank"),q.readyState=q.DONE,u()},w=function(a){return function(){return q.readyState!==q.DONE?a.apply(this,arguments):null}},x={create:!0,exclusive:!1};return q.readyState=q.INIT,d||(d="download"),f?(j=t(b),e.href=j,e.download=d,g(e),q.readyState=q.DONE,void u()):(a.chrome&&r&&r!==k&&(p=b.slice||b.webkitSlice,b=p.call(b,0,b.size,k),s=!0),h&&"download"!==d&&(d+=".download"),(r===k||h)&&(n=a),i?(l+=b.size,void i(a.TEMPORARY,l,w(function(a){a.root.getDirectory("saved",x,w(function(a){var c=function(){a.getFile(d,x,w(function(a){a.createWriter(w(function(c){c.onwriteend=function(b){n.location.href=a.toURL(),m.push(a),q.readyState=q.DONE,o(q,"writeend",b)},c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=q["on"+a]}),c.write(b),q.abort=function(){c.abort(),q.readyState=q.DONE},q.readyState=q.WRITING}),v)}),v)};a.getFile(d,{create:!1},w(function(a){a.remove(),c()}),w(function(a){a.code===a.NOT_FOUND_ERR?c():v()}))}),v)}),v)):void v())},q=p.prototype,r=function(a,b){return new p(a,b)};return q.abort=function(){var a=this;a.readyState=a.DONE,o(a,"abort")},q.readyState=q.INIT=0,q.WRITING=1,q.DONE=2,q.error=q.onwritestart=q.onprogress=q.onwrite=q.onabort=q.onerror=q.onwriteend=null,a.addEventListener("unload",n,!1),r}(self);return a}(),b});